{% extends 'layout.html' %}
{% load static %}

{% block title %}YouBuild | Cotizar {% endblock %}

{% block extra_styles %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'cotizaciones.css' %}" />
{% endblock %}

{% block content %}
<div class="container mt-5 form-container">
    <h2 style="font-family: Arial, sans-serif; font-size: 32px;">Solicitar Cotización</h2>
    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}

        <h3>Detalles del Producto</h3>
        <div id="productos-container">
            {% for producto in carrito %}
            <div class="producto-item row mb-3">
                <div class="col-md-6">
                    <label>Producto</label>
                    <input 
                        type="text" 
                        name="producto" 
                        value="{{ producto.nombre }}" 
                        placeholder="Nombre del producto"
                        readonly 
                        class="form-control">
                </div>
                <div class="col-md-6">
                    <label>Cantidad</label>
                    <input 
                        type="number" 
                        name="cantidad" 
                        value="{{ producto.cantidad }}" 
                        placeholder="Cantidad del producto"
                        class="form-control" 
                        required 
                        min="1">
                    <button 
                        type="button" 
                        class="btn btn-danger mt-2 remove-product" 
                        data-product-id="{{ forloop.counter0 }}">
                        Eliminar
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="row">
            <div class="col-12">
                <button type="button" id="add-product" class="btn btn-orange">+ Agregar otro producto</button>
                <button type="submit" class="btn btn-orange" id="submit-btn" disabled>Enviar Cotización</button>
                <button type="reset" class="btn btn-white-orange" id="reset-form">Limpiar formulario</button>
                <button type="button" class="btn btn-cancel" id="cancel-form">Cancelar</button>
            </div>
        </div>
    </form>
</div>
{% endblock %}
{%block extra_scripts%}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const productosContainer = document.getElementById('productos-container');
        const submitBtn = document.getElementById('submit-btn');
        const addProductBtn = document.getElementById('add-product');
        const resetFormBtn = document.getElementById('reset-form');
        const cancelFormBtn = document.getElementById('cancel-form');
    
        // Habilitar/deshabilitar botón de envío
        const updateSubmitButtonState = () => {
            submitBtn.disabled = !document.querySelector('form').checkValidity();
        };
    
        // Validación en tiempo real
        document.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', updateSubmitButtonState);
        });
    
        // Eliminar producto
        productosContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-product')) {
                const productoItem = event.target.closest('.producto-item');
                const productIndex = Array.from(productosContainer.children).indexOf(productoItem);
    
                fetch(`/eliminar-todo-el-carrito/${productIndex}/`, { 
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    productoItem.remove();
                    updateSubmitButtonState();
                })
                .catch(error => console.error('Error:', error));
            }
        });
    
        // Agregar producto
        addProductBtn.addEventListener('click', () => {
            const newProduct = document.createElement('div');
            newProduct.classList.add('producto-item', 'row', 'mb-3');
            newProduct.innerHTML = `
                <div class="col-md-6">
                    <label>Producto</label>
                    <input type="text" name="producto" 
                        placeholder="Nombre del producto" 
                        class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label>Cantidad</label>
                    <input type="number" name="cantidad" 
                        placeholder="Cantidad del producto" 
                        class="form-control" required min="1">
                    <button type="button" class="btn btn-danger mt-2 remove-product">Eliminar</button>
                </div>
            `;
            productosContainer.appendChild(newProduct);
            updateSubmitButtonState();
        });
    
        // Limpiar formulario
        resetFormBtn.addEventListener('click', (event) => {
            event.preventDefault();
            fetch('/eliminar-todo-el-carrito/', { 
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                productosContainer.innerHTML = '';
                document.querySelectorAll('form input, form textarea').forEach(input => {
                    input.value = '';
                });
                updateSubmitButtonState();
            })
            .catch(error => console.error('Error:', error));
        });
    
        // Cancelar formulario
        cancelFormBtn.addEventListener('click', () => {
            window.location.href = '/'; // Redirigir a página de inicio
        });
    });
</script>
{%endblock%}

